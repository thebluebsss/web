<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý Người dùng</title>

    <!-- React CDN -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        margin-bottom: 20px;
        color: #333;
      }

      /* Search Bar */
      .search-bar {
        margin-bottom: 15px;
      }

      .search-bar input {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 2px solid #ddd;
        border-radius: 4px;
      }

      .search-bar input:focus {
        outline: none;
        border-color: #4caf50;
      }

      /* Buttons */
      button {
        padding: 10px 20px;
        margin: 5px 4px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      button:hover:not(:disabled) {
        opacity: 0.8;
        transform: translateY(-1px);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: #4caf50;
        color: white;
      }

      .btn-edit {
        background: #2196f3;
        color: white;
      }

      .btn-delete {
        background: #f44336;
        color: white;
      }

      .btn-secondary {
        background: #757575;
        color: white;
      }

      /* Table */
      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        min-width: 600px;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border: 1px solid #ddd;
      }

      th {
        background: #4caf50;
        color: white;
        font-weight: bold;
      }

      tr:nth-child(even) {
        background: #f9f9f9;
      }

      tr:hover {
        background: #f5f5f5;
      }

      td button {
        padding: 6px 12px;
        margin: 2px;
      }

      /* Pagination */
      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .pagination select {
        padding: 8px;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .pagination button {
        min-width: 80px;
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-content h3 {
        margin-bottom: 20px;
        color: #333;
      }

      .modal-content label {
        display: block;
        margin-top: 15px;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }

      .modal-content input {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .modal-content input:focus {
        outline: none;
        border-color: #4caf50;
      }

      .error {
        color: #f44336;
        font-size: 12px;
        margin-top: 5px;
      }

      .modal-actions {
        margin-top: 25px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: #666;
      }

      /* Responsive */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .container {
          padding: 15px;
        }

        h1 {
          font-size: 24px;
        }

        table {
          font-size: 12px;
        }

        th,
        td {
          padding: 8px 4px;
        }

        button {
          padding: 8px 12px;
          font-size: 12px;
          min-width: 44px;
          min-height: 44px;
        }

        .modal-content {
          padding: 20px;
        }

        .pagination {
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      function App() {
        const [users, setUsers] = useState([]);
        const [page, setPage] = useState(1);
        const [limit, setLimit] = useState(5);
        const [search, setSearch] = useState("");
        const [total, setTotal] = useState(0);
        const [totalPages, setTotalPages] = useState(0);
        const [showModal, setShowModal] = useState(false);
        const [editingUser, setEditingUser] = useState(null);
        const [loading, setLoading] = useState(false);

        // Fetch users
        const fetchUsers = async () => {
          setLoading(true);
          const url = `http://localhost:3001/api/users?page=${page}&limit=${limit}&search=${search}`;

          try {
            const response = await fetch(url);
            const data = await response.json();

            setUsers(data.data);
            setTotal(data.total);
            setTotalPages(data.totalPages);
          } catch (err) {
            console.error("Fetch error:", err);
            alert("Lỗi khi tải dữ liệu: " + err.message);
          } finally {
            setLoading(false);
          }
        };

        // Delete user
        const deleteUser = async (id) => {
          try {
            const response = await fetch(
              `http://localhost:3001/api/users/${id}`,
              {
                method: "DELETE",
              }
            );

            const data = await response.json();

            if (!response.ok) {
              alert("Lỗi: " + data.error);
            } else {
              alert(data.message);
              fetchUsers();
            }
          } catch (err) {
            alert("Lỗi: " + err.message);
          }
        };

        // Handle limit change - reset page về 1
        const handleLimitChange = (newLimit) => {
          setLimit(newLimit);
          setPage(1);
        };

        // useEffect: Gọi API khi page, limit, search thay đổi
        useEffect(() => {
          fetchUsers();
        }, [page, limit, search]);

        return (
          <div className="container">
            <h1>Quản lý Người dùng</h1>

            <SearchBar value={search} onChange={setSearch} />

            <button
              className="btn-primary"
              onClick={() => {
                setEditingUser(null);
                setShowModal(true);
              }}
            >
              + Thêm người dùng
            </button>

            {loading ? (
              <div className="loading">Đang tải dữ liệu...</div>
            ) : (
              <UserTable
                users={users}
                page={page}
                limit={limit}
                onEdit={(user) => {
                  setEditingUser(user);
                  setShowModal(true);
                }}
                onDelete={deleteUser}
              />
            )}

            <Pagination
              page={page}
              totalPages={totalPages}
              limit={limit}
              onPageChange={setPage}
              onLimitChange={handleLimitChange}
            />

            {showModal && (
              <UserModal
                user={editingUser}
                onClose={() => setShowModal(false)}
                onSave={() => {
                  fetchUsers();
                  setShowModal(false);
                }}
              />
            )}
          </div>
        );
      }
      const { useState, useEffect } = React;

      function SearchBar({ value, onChange }) {
        const [searchInput, setSearchInput] = useState(value);

        useEffect(() => {
          const timer = setTimeout(() => {
            onChange(searchInput);
          }, 200); // Đợi 200ms sau khi user ngừng gõ

          return () => clearTimeout(timer);
        }, [searchInput]);

        return (
          <div className="search-bar">
            <input
              type="text"
              placeholder="Tìm theo tên, email, địa chỉ..."
              value={searchInput}
              onChange={(e) => setSearchInput(e.target.value)}
            />
          </div>
        );
      }

      function UserTable({ users, onEdit, onDelete, page, limit }) {
        const handleDelete = (id, name) => {
          if (window.confirm(`Bạn có chắc muốn xóa "${name}"?`)) {
            onDelete(id);
          }
        };

        return (
          <div className="table-container">
            <table>
              <thead>
                <tr>
                  <th>STT</th>
                  <th>Họ tên</th>
                  <th>Tuổi</th>
                  <th>Email</th>
                  <th>Địa chỉ</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                {users.length === 0 ? (
                  <tr>
                    <td colSpan="6" style={{ textAlign: "center" }}>
                      Không có dữ liệu
                    </td>
                  </tr>
                ) : (
                  users.map((user, index) => (
                    <tr key={user._id}>
                      <td>{(page - 1) * limit + index + 1}</td>
                      <td>{user.name}</td>
                      <td>{user.age}</td>
                      <td>{user.email}</td>
                      <td>{user.address || "-"}</td>
                      <td>
                        <button
                          className="btn-edit"
                          onClick={() => onEdit(user)}
                        >
                          Sửa
                        </button>
                        <button
                          className="btn-delete"
                          onClick={() => handleDelete(user._id, user.name)}
                        >
                          Xóa
                        </button>
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        );
      }

      // Component Pagination
      function Pagination({
        page,
        totalPages,
        limit,
        onPageChange,
        onLimitChange,
      }) {
        return (
          <div className="pagination">
            <div>
              Hiển thị:
              <select
                value={limit}
                onChange={(e) => onLimitChange(Number(e.target.value))}
              >
                <option value="3">3</option>
                <option value="5">5</option>
                <option value="10">10</option>
              </select>
              dòng/trang
            </div>
            <div>
              <button
                onClick={() => onPageChange(page - 1)}
                disabled={page === 1}
              >
                Prev
              </button>
              <span style={{ margin: "0 15px" }}>
                Trang {page}/{totalPages || 1}
              </span>
              <button
                onClick={() => onPageChange(page + 1)}
                disabled={page >= totalPages}
              >
                Next
              </button>
            </div>
          </div>
        );
      }

      // Component UserModal
      function UserModal({ user, onClose, onSave }) {
        const [formData, setFormData] = useState(
          user || { name: "", age: "", email: "", address: "" }
        );
        const [errors, setErrors] = useState({});
        const [loading, setLoading] = useState(false);

        const handleChange = (e) => {
          setFormData({ ...formData, [e.target.name]: e.target.value });
          if (errors[e.target.name]) {
            setErrors({ ...errors, [e.target.name]: "" });
          }
        };

        const validate = () => {
          const newErrors = {};

          if (!formData.name || formData.name.trim().length < 2) {
            newErrors.name = "Tên phải có ít nhất 2 ký tự";
          }

          const age = parseInt(formData.age);
          if (!formData.age || isNaN(age) || age < 0) {
            newErrors.age = "Tuổi phải là số >= 0";
          }

          if (
            !formData.email ||
            !formData.email.includes("@") ||
            !formData.email.includes(".")
          ) {
            newErrors.email = "Email không hợp lệ";
          }

          setErrors(newErrors);
          return Object.keys(newErrors).length === 0;
        };

        const handleSubmit = async () => {
          if (!validate()) return;

          setLoading(true);

          const cleanData = {
            name: formData.name.trim(),
            age: parseInt(formData.age),
            email: formData.email.trim(),
            address: formData.address.trim(),
          };

          const url = user
            ? `http://localhost:3001/api/users/${user._id}`
            : `http://localhost:3001/api/users`;
          const method = user ? "PUT" : "POST";

          try {
            const response = await fetch(url, {
              method,
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(cleanData),
            });

            const data = await response.json();

            if (!response.ok) {
              alert("Lỗi: " + data.error);
            } else {
              alert(data.message);
              onSave();
            }
          } catch (err) {
            alert("Lỗi kết nối: " + err.message);
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <h3>{user ? "Sửa người dùng" : "Thêm người dùng"}</h3>

              <label>Họ tên *</label>
              <input
                name="name"
                value={formData.name}
                onChange={handleChange}
              />
              {errors.name && <p className="error">{errors.name}</p>}

              <label>Tuổi *</label>
              <input
                name="age"
                type="number"
                value={formData.age}
                onChange={handleChange}
              />
              {errors.age && <p className="error">{errors.age}</p>}

              <label>Email *</label>
              <input
                name="email"
                type="email"
                value={formData.email}
                onChange={handleChange}
              />
              {errors.email && <p className="error">{errors.email}</p>}

              <label>Địa chỉ</label>
              <input
                name="address"
                value={formData.address}
                onChange={handleChange}
              />

              <div className="modal-actions">
                <button
                  className="btn-primary"
                  onClick={handleSubmit}
                  disabled={loading}
                >
                  {loading ? "Đang lưu..." : "Lưu"}
                </button>
                <button
                  className="btn-secondary"
                  onClick={onClose}
                  disabled={loading}
                >
                  Hủy
                </button>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
